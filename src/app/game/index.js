import { createSlice } from '@reduxjs/toolkit'

const initialState = {
  cleanTables: [
    {
      result: null,
      fields: [
        { id: 0, value: null },
        { id: 1, value: null },
        { id: 2, value: null },
        { id: 3, value: null },
        { id: 4, value: null },
        { id: 5, value: null },
        { id: 6, value: null },
        { id: 7, value: null },
        { id: 8, value: null },
      ],
    },
    {
      result: null,
      fields: [
        { id: 0, value: null },
        { id: 1, value: null },
        { id: 2, value: null },
        { id: 3, value: null },
        { id: 4, value: null },
        { id: 5, value: null },
        { id: 6, value: null },
        { id: 7, value: null },
        { id: 8, value: null },
      ],
    },
    {
      result: null,
      fields: [
        { id: 0, value: null },
        { id: 1, value: null },
        { id: 2, value: null },
        { id: 3, value: null },
        { id: 4, value: null },
        { id: 5, value: null },
        { id: 6, value: null },
        { id: 7, value: null },
        { id: 8, value: null },
      ],
    },
    {
      result: null,
      fields: [
        { id: 0, value: null },
        { id: 1, value: null },
        { id: 2, value: null },
        { id: 3, value: null },
        { id: 4, value: null },
        { id: 5, value: null },
        { id: 6, value: null },
        { id: 7, value: null },
        { id: 8, value: null },
      ],
    },
    {
      result: null,
      fields: [
        { id: 0, value: null },
        { id: 1, value: null },
        { id: 2, value: null },
        { id: 3, value: null },
        { id: 4, value: null },
        { id: 5, value: null },
        { id: 6, value: null },
        { id: 7, value: null },
        { id: 8, value: null },
      ],
    },
    {
      result: null,
      fields: [
        { id: 0, value: null },
        { id: 1, value: null },
        { id: 2, value: null },
        { id: 3, value: null },
        { id: 4, value: null },
        { id: 5, value: null },
        { id: 6, value: null },
        { id: 7, value: null },
        { id: 8, value: null },
      ],
    },
    {
      result: null,
      fields: [
        { id: 0, value: null },
        { id: 1, value: null },
        { id: 2, value: null },
        { id: 3, value: null },
        { id: 4, value: null },
        { id: 5, value: null },
        { id: 6, value: null },
        { id: 7, value: null },
        { id: 8, value: null },
      ],
    },
    {
      result: null,
      fields: [
        { id: 0, value: null },
        { id: 1, value: null },
        { id: 2, value: null },
        { id: 3, value: null },
        { id: 4, value: null },
        { id: 5, value: null },
        { id: 6, value: null },
        { id: 7, value: null },
        { id: 8, value: null },
      ],
    },
    {
      result: null,
      fields: [
        { id: 0, value: null },
        { id: 1, value: null },
        { id: 2, value: null },
        { id: 3, value: null },
        { id: 4, value: null },
        { id: 5, value: null },
        { id: 6, value: null },
        { id: 7, value: null },
        { id: 8, value: null },
      ],
    },
  ],
  tables: [
    {
      result: null,
      fields: [
        { id: 0, value: null },
        { id: 1, value: null },
        { id: 2, value: null },
        { id: 3, value: null },
        { id: 4, value: null },
        { id: 5, value: null },
        { id: 6, value: null },
        { id: 7, value: null },
        { id: 8, value: null },
      ],
    },
    {
      result: null,
      fields: [
        { id: 0, value: null },
        { id: 1, value: null },
        { id: 2, value: null },
        { id: 3, value: null },
        { id: 4, value: null },
        { id: 5, value: null },
        { id: 6, value: null },
        { id: 7, value: null },
        { id: 8, value: null },
      ],
    },
    {
      result: null,
      fields: [
        { id: 0, value: null },
        { id: 1, value: null },
        { id: 2, value: null },
        { id: 3, value: null },
        { id: 4, value: null },
        { id: 5, value: null },
        { id: 6, value: null },
        { id: 7, value: null },
        { id: 8, value: null },
      ],
    },
    {
      result: null,
      fields: [
        { id: 0, value: null },
        { id: 1, value: null },
        { id: 2, value: null },
        { id: 3, value: null },
        { id: 4, value: null },
        { id: 5, value: null },
        { id: 6, value: null },
        { id: 7, value: null },
        { id: 8, value: null },
      ],
    },
    {
      result: null,
      fields: [
        { id: 0, value: null },
        { id: 1, value: null },
        { id: 2, value: null },
        { id: 3, value: null },
        { id: 4, value: null },
        { id: 5, value: null },
        { id: 6, value: null },
        { id: 7, value: null },
        { id: 8, value: null },
      ],
    },
    {
      result: null,
      fields: [
        { id: 0, value: null },
        { id: 1, value: null },
        { id: 2, value: null },
        { id: 3, value: null },
        { id: 4, value: null },
        { id: 5, value: null },
        { id: 6, value: null },
        { id: 7, value: null },
        { id: 8, value: null },
      ],
    },
    {
      result: null,
      fields: [
        { id: 0, value: null },
        { id: 1, value: null },
        { id: 2, value: null },
        { id: 3, value: null },
        { id: 4, value: null },
        { id: 5, value: null },
        { id: 6, value: null },
        { id: 7, value: null },
        { id: 8, value: null },
      ],
    },
    {
      result: null,
      fields: [
        { id: 0, value: null },
        { id: 1, value: null },
        { id: 2, value: null },
        { id: 3, value: null },
        { id: 4, value: null },
        { id: 5, value: null },
        { id: 6, value: null },
        { id: 7, value: null },
        { id: 8, value: null },
      ],
    },
    {
      result: null,
      fields: [
        { id: 0, value: null },
        { id: 1, value: null },
        { id: 2, value: null },
        { id: 3, value: null },
        { id: 4, value: null },
        { id: 5, value: null },
        { id: 6, value: null },
        { id: 7, value: null },
        { id: 8, value: null },
      ],
    },
  ],
  turn: 1,
  activeTable: null,
  scores: [0, 0],
}

const game = createSlice({
  name: 'game',
  initialState,
  reducers: {
    _makeMove: (state, { payload: { tableId, fieldId } }) => {
      const { tables } = state
      const table = tables[tableId]
      const { fields } = table
      fields[fieldId].value = state.turn

      state.turn = (state.turn + 1) % 2

      const checkHorizontal = () => {
        let horizontal, value
        for (let index = 0; index < 3; index++) {
          const id = index * 3

          horizontal =
            fields[id].value === fields[id + 1].value &&
            fields[id].value === fields[id + 2].value &&
            fields[id].value !== null

          if (horizontal) {
            value = fields[id].value
            break
          }
        }
        return { finished: horizontal, value }
      }

      const checkVertical = () => {
        let vertical, value
        for (let index = 0; index < 3; index++) {
          const id = index

          vertical =
            fields[id].value === fields[id + 3].value &&
            fields[id].value === fields[id + 6].value &&
            fields[id].value !== null

          if (vertical) {
            value = fields[id].value
            break
          }
        }
        return { finished: vertical, value }
      }

      const checkCross = () => {
        let cross, value

        //  0, 4, 8,            2, 4, 6
        cross =
          fields[0].value === fields[4].value &&
          fields[0].value === fields[8].value &&
          fields[0].value !== null

        value = fields[0].value

        if (cross) {
          return { finished: true, value }
        }

        cross =
          fields[2].value === fields[4].value &&
          fields[2].value === fields[6].value &&
          fields[2].value !== null

        value = fields[2].value

        return { finished: cross, value }
      }

      const horizontal = checkHorizontal()
      const vertical = checkVertical()
      const cross = checkCross()

      if (horizontal.finished) {
        table.result = horizontal.value
      } else if (vertical.finished) {
        table.result = vertical.value
      } else if (cross.finished) {
        table.result = cross.value
      }

      state.activeTable = tables[fieldId].result === null ? fieldId : null

      if (horizontal.finished || vertical.finished || cross.finished) {
        const tableCheckHorizontal = () => {
          let horizontal, value
          for (let index = 0; index < 3; index++) {
            const id = index * 3

            horizontal =
              tables[id].result === tables[id + 1].result &&
              tables[id].result === tables[id + 2].result &&
              tables[id].result !== null

            if (horizontal) {
              value = tables[id].result
              break
            }
          }
          return { finished: horizontal, value }
        }

        const tableCheckVertical = () => {
          let vertical, value
          for (let index = 0; index < 3; index++) {
            const id = index

            vertical =
              tables[id].result === tables[id + 3].result &&
              tables[id].result === tables[id + 6].result &&
              tables[id].result !== null

            if (vertical) {
              value = tables[id].result
              break
            }
          }
          return { finished: vertical, value }
        }

        const tableCheckCross = () => {
          let cross, value

          //  0, 4, 8,            2, 4, 6
          cross =
            tables[0].result === tables[4].result &&
            tables[0].result === tables[8].result &&
            tables[0].result !== null

          value = tables[0].result

          if (cross) {
            return { finished: true, value }
          }

          cross =
            tables[2].result === tables[4].result &&
            tables[2].result === tables[6].result &&
            tables[2].result !== null

          value = tables[2].result

          return { finished: cross, value }
        }

        const tableHorizontal = tableCheckHorizontal()
        const tableVertical = tableCheckVertical()
        const tableCross = tableCheckCross()

        if (
          tableHorizontal.finished ||
          tableVertical.finished ||
          tableCross.finished
        ) {
          state.tables = [...state.cleanTables]
          const winner =
            tableHorizontal.value || tableVertical.value || tableCross.value
          state.scores = [
            winner ? state.scores[0] + 1 : state.scores[0],
            !winner ? state.scores[1] + 1 : state.scores[1],
          ]
          state.activeTable = null
        }
      }
    },
  },
})

export const { _makeMove } = game.actions
export default game.reducer
